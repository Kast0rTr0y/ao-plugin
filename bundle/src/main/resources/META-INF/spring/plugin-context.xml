<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/osgi"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xsi:schemaLocation="http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi-1.1.xsd
                                 http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.1.xsd">

    <service id="ao" interface="com.atlassian.activeobjects.external.ActiveObjects">
        <!--suppress SpringOsgiServiceCommonInspection, because we're using the ServiceFactory, IDEA gets confused -->
        <beans:bean class="com.atlassian.activeobjects.internal.ActiveObjectsServiceFactory">
            <beans:constructor-arg index="0" ref="aoProvider"/>
            <beans:constructor-arg index="1">
                <beans:bean class="com.atlassian.activeobjects.internal.PluginKeyFactoryImpl"/>
            </beans:constructor-arg>
        </beans:bean>
    </service>

    <reference id="activeObjectsConfiguration" interface="com.atlassian.activeobjects.external.ActiveObjectsConfiguration" cardinality="0..1" timeout="0">
        <listener bind-method="onActiveObjectsConfigurationServiceBind" unbind-method="onActiveObjectsConfigurationServiceUnbind">
            <beans:bean class="com.atlassian.activeobjects.internal.ActiveObjectsConfigurationServiceListener">
                <beans:constructor-arg ref="registry"/>
            </beans:bean>
        </listener>
    </reference>

    <beans:bean id="aoProvider" class="com.atlassian.activeobjects.internal.RegistryBasedActiveObjectsProvider">
        <beans:constructor-arg index="0" ref="registry"/>
        <beans:constructor-arg index="1">
            <beans:bean class="com.atlassian.activeobjects.internal.DelegatingActiveObjectsFactoryResolver">
                <beans:constructor-arg index="0">
                    <beans:list>
                        <beans:bean class="com.atlassian.activeobjects.internal.HomeDirectoryHsqlDbActiveObjectsFactoryResolver">
                            <beans:constructor-arg index="0">
                                <beans:bean class="com.atlassian.activeobjects.internal.DatabaseDirectoryAwareActiveObjectsFactory">
                                    <beans:constructor-arg index="0">
                                        <reference interface="com.atlassian.sal.api.ApplicationProperties" timeout="5000"/>
                                    </beans:constructor-arg>
                                    <beans:constructor-arg index="1">
                                        <beans:bean class="com.atlassian.activeobjects.internal.DefaultDatabaseConfiguration">
                                            <beans:constructor-arg ref="activeObjectsConfiguration"/>
                                        </beans:bean>
                                    </beans:constructor-arg>
                                    <beans:constructor-arg index="2" ref="tableNameConverter"/>
                                    <beans:constructor-arg index="3" ref="fieldNameConverter"/>
                                    <beans:constructor-arg index="4" ref="schemaConfiguration"/>
                                </beans:bean>
                            </beans:constructor-arg>
                        </beans:bean>
                        <beans:bean class="com.atlassian.activeobjects.internal.ApplicationDataSourceProviderActiveObjectsFactoryResolver">
                            <beans:constructor-arg>
                                <beans:bean class="com.atlassian.activeobjects.internal.DataSourceProviderActiveObjectsFactory">
                                    <beans:constructor-arg index="0">
                                        <beans:bean class="com.atlassian.activeobjects.internal.EntityManagerFactoryImpl">
                                            <beans:constructor-arg index="0">
                                                <beans:bean class="com.atlassian.activeobjects.internal.JdbcDriverDatabaseProviderFactory">
                                                    <beans:constructor-arg>
                                                        <beans:bean class="com.atlassian.activeobjects.internal.DriverNameExtractorImpl"/>
                                                    </beans:constructor-arg>
                                                </beans:bean>
                                            </beans:constructor-arg>
                                            <beans:constructor-arg index="1" ref="tableNameConverter"/>
                                            <beans:constructor-arg index="2" ref="fieldNameConverter"/>
                                            <beans:constructor-arg index="3" ref="schemaConfiguration"/>
                                        </beans:bean>
                                    </beans:constructor-arg>
                                    <beans:constructor-arg index="1">
                                        <reference interface="com.atlassian.sal.api.sql.DataSourceProvider" timeout="5000"/>
                                    </beans:constructor-arg>
                                    <beans:constructor-arg index="2">
                                        <reference interface="com.atlassian.sal.api.transaction.TransactionTemplate" timeout="5000"/>
                                    </beans:constructor-arg>
                                </beans:bean>
                            </beans:constructor-arg>
                        </beans:bean>
                    </beans:list>
                </beans:constructor-arg>
            </beans:bean>
        </beans:constructor-arg>
        <beans:constructor-arg index="2">
            <beans:bean class="com.atlassian.activeobjects.internal.DataSourceTypeResolverImpl">
                <beans:constructor-arg index="0">
                    <reference interface="com.atlassian.sal.api.pluginsettings.PluginSettingsFactory"/>
                </beans:constructor-arg>
                <beans:constructor-arg index="1" value="APPLICATION"/>
            </beans:bean>
        </beans:constructor-arg>
    </beans:bean>

    <beans:bean id="tableNameConverter" class="com.atlassian.activeobjects.internal.PrefixedTableNameConverter">
        <beans:constructor-arg index="0" ref="prefix"/>
        <beans:constructor-arg index="1">
            <beans:bean class="net.java.ao.schema.CamelCaseTableNameConverter"/>
        </beans:constructor-arg>
    </beans:bean>
    <beans:bean id="fieldNameConverter" class="net.java.ao.schema.CamelCaseFieldNameConverter"/>
    <beans:bean id="schemaConfiguration" class="com.atlassian.activeobjects.internal.PrefixedSchemaConfiguration">
        <beans:constructor-arg index="0" ref="prefix"/>
    </beans:bean>

    <beans:bean id="prefix" class="com.atlassian.activeobjects.internal.PluginPrefix"/>

    <beans:bean id="registry" class="com.atlassian.activeobjects.internal.WeakReferencedActiveObjectsRegistry"/>
</beans:beans>
